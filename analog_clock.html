<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Analog Clock Reading Test</title>
<style>
  :root {
    color-scheme: light;
    --bg: radial-gradient(circle at top, #f9fbff 0%, #e2ecff 35%, #d7e6ff 100%);
    --panel-bg: #ffffff;
    --panel-border: rgba(10, 56, 113, 0.12);
    --text: #0b1930;
    --muted: #56627a;
    --accent: #0f62fe;
    --accent-dark: #0b4bd8;
    --shadow: 0 18px 45px rgba(15, 36, 84, 0.18);
    --radius-xl: 22px;
    --radius-md: 14px;
  }

  * { box-sizing: border-box; }

  html, body {
    height: 100%;
    margin: 0;
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
  }

  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  header {
    padding: 20px clamp(20px, 4vw, 48px) 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
  }

  header h1 {
    font-size: clamp(22px, 3vw, 32px);
    margin: 0;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  header a {
    color: var(--accent);
    text-decoration: none;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  header a:hover,
  header a:focus {
    color: var(--accent-dark);
  }

  main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: clamp(20px, 4vw, 50px);
  }

  .wrap {
    display: grid;
    grid-template-columns: minmax(0, 1fr) clamp(320px, 35vw, 360px);
    gap: clamp(20px, 3vw, 36px);
    width: min(1100px, 100%);
  }

  .wrap:fullscreen,
  .wrap:-webkit-full-screen,
  .wrap:-moz-full-screen {
    width: 100vw;
    height: 100vh;
    max-width: none;
    align-items: center;
  }

  .panel {
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius-xl);
    padding: clamp(18px, 2vw, 26px);
    box-shadow: var(--shadow);
    backdrop-filter: blur(10px);
  }

  @keyframes flashGood {
    0%, 100% {
      background: var(--panel-bg);
      border-color: var(--panel-border);
      box-shadow: var(--shadow);
    }
    50% {
      background: rgba(11, 140, 88, 0.18);
      border-color: rgba(11, 140, 88, 0.8);
      box-shadow: 0 0 0 4px rgba(11, 140, 88, 0.35);
    }
  }

  @keyframes flashBad {
    0%, 100% {
      background: var(--panel-bg);
      border-color: var(--panel-border);
      box-shadow: var(--shadow);
    }
    50% {
      background: rgba(201, 24, 74, 0.18);
      border-color: rgba(201, 24, 74, 0.8);
      box-shadow: 0 0 0 4px rgba(201, 24, 74, 0.35);
    }
  }

  .wrap.flash-good .panel {
    animation: flashGood 0.8s ease-in-out 2;
  }

  .wrap.flash-bad .panel {
    animation: flashBad 0.8s ease-in-out 2;
  }

  h1 {
    font-size: clamp(20px, 2.4vw, 26px);
    margin: 0 0 14px;
  }

  .panel p,
  label,
  .dial-note {
    color: var(--muted);
    font-size: 15px;
  }

  canvas#clock {
    width: 100%;
    height: auto;
    max-width: 720px;
    display: block;
    margin: 0 auto;
  }

  .topbar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }

  #timer {
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    padding: 8px 14px;
    background: rgba(15, 98, 254, 0.08);
    border: 1px solid rgba(15, 98, 254, 0.25);
    border-radius: var(--radius-md);
  }

  .dial-note {
    margin-top: 18px;
  }

  .controls label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }

  .row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 18px;
    flex-wrap: wrap;
  }

  .row.actions {
    margin-top: 6px;
    gap: 10px;
  }

  .row.voice-row {
    align-items: flex-start;
    gap: 14px;
  }

  #voiceStatus {
    flex: 1;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.4;
    min-height: 24px;
  }

  #voiceStatus strong {
    color: var(--text);
  }

  .voice-active {
    background: rgba(15, 98, 254, 0.18);
    color: var(--accent-dark);
  }

  select {
    border-radius: var(--radius-md);
    border: 1px solid rgba(15, 36, 84, 0.25);
    padding: 8px 14px;
    font-size: 15px;
    background-color: #fff;
    min-width: 80px;
  }

  button {
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    font-weight: 600;
    padding: 9px 16px;
    font-size: 15px;
    transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
  }

  button:hover {
    transform: translateY(-1px);
  }

  button:active {
    transform: translateY(0);
  }

  button:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .primary {
    background: var(--accent);
    color: #fff;
    box-shadow: 0 12px 20px rgba(15, 98, 254, 0.25);
  }

  .primary:hover,
  .primary:focus {
    background: var(--accent-dark);
  }

  .ghost {
    background: rgba(15, 36, 84, 0.08);
    color: var(--accent-dark);
  }

  .ghost:hover,
  .ghost:focus {
    background: rgba(15, 36, 84, 0.12);
  }

  .answer {
    min-height: 32px;
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 18px;
  }

  .answer .ok { color: #0b8c58; }
  .answer .bad { color: #c9184a; }

  .score {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 14px;
  }

  .card {
    border-radius: var(--radius-md);
    padding: 14px 16px;
    background: rgba(15, 98, 254, 0.08);
    color: var(--accent-dark);
    text-align: center;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
  }

  .card div:first-child {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 6px;
  }

  .metric {
    font-size: 24px;
    font-weight: 700;
  }

  footer {
    text-align: center;
    padding: 20px clamp(20px, 4vw, 40px) 40px;
    color: var(--muted);
    font-size: 14px;
  }

  @media (max-width: 900px) {
    .wrap {
      grid-template-columns: 1fr;
    }

    .panel {
      padding: clamp(18px, 4vw, 28px);
    }

    header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
</head>
<body>
  <header>
    <h1>Analog Clock Reading Trainer</h1>
    <a href="index.html">‚Üê Back to Main Activities</a>
  </header>
  <main>
    <div class="wrap">
      <div class="panel" id="clockPanel">
        <h1>Read the Clock</h1>
        <div class="topbar">
          <button id="fs" class="ghost" title="Toggle full screen">Full Screen</button>
          <span id="timer" aria-live="polite">00:00.0</span>
        </div>
        <canvas id="clock" width="800" height="800" aria-label="Analog clock showing a random time"></canvas>
        <div class="dial-note">Only hour numbers are shown. Minute tick marks appear only in 1‚Äëmin mode. Hour and minute hands use strong contrast.</div>
      </div>

      <div class="panel controls" role="form" aria-label="Answer controls">
        <h1>Your Answer</h1>

        <label for="gran">Minute granularity</label>
        <div class="row">
          <select id="gran">
            <option value="1">Exact minute (1‚Äëmin)</option>
            <option value="5" selected>5‚Äëminute steps</option>
            <option value="15">15‚Äëminute steps</option>
          </select>
          <button id="new" class="ghost">New time</button>
        </div>

        <label>Enter time</label>
        <div class="row">
          <select id="hour"></select>
          <span>:</span>
          <select id="minute"></select>
        </div>

        <div class="row voice-row" id="voiceRow">
          <button id="voice" class="ghost" type="button">üîä Voice On</button>
          <div id="voiceStatus" aria-live="polite"></div>
        </div>

        <div class="row actions">
          <button id="check" class="primary">Check</button>
          <button id="show" class="ghost">Show answer</button>
          <button id="restart" class="ghost">Restart</button>
        </div>

        <div id="feedback" class="answer" aria-live="polite"></div>

        <div class="score">
          <div class="card"><div>Correct</div><div id="scCorrect" class="metric">0</div></div>
          <div class="card"><div>Attempts</div><div id="scAttempts" class="metric">0</div></div>
          <div class="card"><div>Streak</div><div id="scStreak" class="metric">0</div></div>
          <div class="card"><div>Points</div><div id="scPoints" class="metric">0</div></div>
        </div>
      </div>
    </div>
  </main>
  <footer>
    Practice reading analog time and track your progress with quick feedback.
  </footer>

<script>
// ES5 only
(function(){
  var canvas = document.getElementById('clock');
  var ctx = canvas.getContext('2d');
  var panel = document.getElementById('clockPanel');
  var elWrap = document.querySelector('.wrap');
  var btnFS = document.getElementById('fs');
  var elTimer = document.getElementById('timer');

  // HiDPI scaling for sharp lines
  function scaleForDPR() {
    var dpr = window.devicePixelRatio || 1;
    var rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.width * dpr); // keep square
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }

  // State
  var state = {
    hour: 12,
    minute: 0,
    gran: 5,
    correct: 0,
    attempts: 0,
    streak: 0,
    points: 0,
    qStart: 0,
    timerId: null
  };

  // Elements
  var elGran = document.getElementById('gran');
  var elHour = document.getElementById('hour');
  var elMinute = document.getElementById('minute');
  var elNew = document.getElementById('new');
  var elCheck = document.getElementById('check');
  var elShow = document.getElementById('show');
  var elRestart = document.getElementById('restart');
  var elFeedback = document.getElementById('feedback');
  var elSC = document.getElementById('scCorrect');
  var elSA = document.getElementById('scAttempts');
  var elSS = document.getElementById('scStreak');
  var elSP = document.getElementById('scPoints');
  var elVoiceBtn = document.getElementById('voice');
  var elVoiceStatus = document.getElementById('voiceStatus');
  var elVoiceRow = document.getElementById('voiceRow');

  var WRONG_PENALTY = 10; // points deducted per wrong attempt
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  var recognition = null;
  var listening = false;
  var speechEnabled = false;

  function setMinuteOptions(gran) {
    var i;
    elMinute.innerHTML = '';
    for (i = 0; i < 60; i += gran) {
      var opt = document.createElement('option');
      opt.value = i;
      opt.text = pad2(i);
      elMinute.appendChild(opt);
    }
  }

  function setHourOptions() {
    var i;
    elHour.innerHTML = '';
    for (i = 1; i <= 12; i++) {
      var opt = document.createElement('option');
      opt.value = i;
      opt.text = i;
      elHour.appendChild(opt);
    }
  }

  function pad2(n) { return (n < 10 ? '0' : '') + n; }

  function setVoiceStatus(text) {
    if (elVoiceStatus) {
      elVoiceStatus.textContent = text;
    }
  }

  function clearVoiceStatus() {
    if (!SpeechRecognition && elVoiceBtn && elVoiceBtn.disabled) { return; }
    if (speechEnabled) {
      setVoiceStatus('Listening‚Ä¶ say the time like "three fifteen".');
    } else if (recognition) {
      if (!elVoiceStatus || !elVoiceStatus.textContent) {
        setVoiceStatus('Voice input is off.');
      }
    } else {
      setVoiceStatus('');
    }
  }

  function updateVoiceUI() {
    if (!elVoiceBtn) { return; }
    if (speechEnabled) {
      var label = listening ? 'üîä Voice On (listening)' : 'üîä Voice On';
      elVoiceBtn.textContent = label;
      elVoiceBtn.classList.add('voice-active');
    } else {
      elVoiceBtn.textContent = 'üé§ Voice Off';
      elVoiceBtn.classList.remove('voice-active');
    }
    elVoiceBtn.setAttribute('aria-pressed', speechEnabled ? 'true' : 'false');
  }

  function ensureVoiceListening() {
    if (!recognition || !speechEnabled || listening) {
      updateVoiceUI();
      return;
    }
    try {
      recognition.start();
      listening = true;
      setVoiceStatus('Listening‚Ä¶ say the time like "three fifteen".');
    } catch (err) {
      if (err && err.name === 'InvalidStateError') {
        listening = true;
      } else {
        listening = false;
        setVoiceStatus('Unable to access the microphone. Please try again.');
      }
    }
    updateVoiceUI();
  }

  function disableVoice(message) {
    speechEnabled = false;
    if (recognition && listening) {
      listening = false;
      try { recognition.stop(); }
      catch (err) {
        try { recognition.abort(); } catch (err2) {}
      }
    }
    updateVoiceUI();
    if (message) {
      setVoiceStatus(message);
    } else if (recognition) {
      setVoiceStatus('Voice input is off.');
    } else {
      setVoiceStatus('');
    }
  }

  function enableVoice() {
    speechEnabled = true;
    updateVoiceUI();
    ensureVoiceListening();
  }

  function alignMinuteToGran(minute) {
    var gran = state.gran || 1;
    var maxStep = Math.floor(59 / gran);
    var step = Math.round(minute / gran);
    if (step > maxStep) { step = maxStep; }
    if (step < 0) { step = 0; }
    return step * gran;
  }

  function setSelectValue(select, value) {
    if (!select) { return false; }
    var options = select.options;
    var i;
    for (i = 0; i < options.length; i++) {
      if (String(options[i].value) === String(value)) {
        select.value = String(value);
        return true;
      }
    }
    return false;
  }

  function applyVoiceResult(result, transcript) {
    if (!result) { return; }
    var hour = result.hour;
    var minute = result.minute;
    if (!setSelectValue(elHour, hour)) {
      elHour.value = String(((hour - 1 + 12) % 12) + 1);
    }
    var displayMinute = minute;
    if (!setSelectValue(elMinute, minute)) {
      var aligned = alignMinuteToGran(minute);
      if (setSelectValue(elMinute, aligned)) {
        displayMinute = aligned;
      } else if (elMinute && elMinute.options.length) {
        elMinute.selectedIndex = 0;
        displayMinute = parseInt(elMinute.value, 10);
      }
    }
    if (elMinute) {
      displayMinute = parseInt(elMinute.value, 10);
    }
    setVoiceStatus('Heard "' + transcript + '" ‚Üí ' + elHour.value + ':' + pad2(displayMinute));
  }

  function handleVoiceResult(event) {
    if (!event || !event.results || !event.results[0]) { return; }
    var alternatives = event.results[0];
    var i;
    var transcript;
    var parsed = null;
    for (i = 0; i < alternatives.length; i++) {
      transcript = alternatives[i].transcript.trim();
      parsed = parseSpeechTime(transcript);
      if (parsed) {
        applyVoiceResult(parsed, transcript);
        if (speechEnabled) {
          checkAnswer();
        }
        break;
      }
    }
    if (!parsed) {
      transcript = alternatives[0].transcript.trim();
      setVoiceStatus('Heard "' + transcript + '" but could not understand the time.');
    }
  }

  function parseSpeechTime(raw) {
    if (!raw) { return null; }
    var text = String(raw).toLowerCase();
    text = text.replace(/-/g, ' ');
    text = text.replace(/[\.,!?]/g, ' ');
    text = text.replace(/'/g, ' ');
    text = text.replace(/\b(?:o'clock|oclock)\b/g, ' ');
    text = text.replace(/\b(?:the time is|time is|it is|it\s+s|its|it's|thats|that's)\b/g, ' ');
    text = text.replace(/\b(?:p\.?m\.?|a\.?m\.?)\b/g, ' ');
    text = text.replace(/\s+/g, ' ').trim();
    if (!text) { return null; }

    var colonMatch = text.match(/(\d{1,2})\s*:\s*(\d{1,2})/);
    if (colonMatch) {
      return finalizeTime(parseInt(colonMatch[1], 10), parseInt(colonMatch[2], 10));
    }

    var tokens = text.split(' ');

    var pastIndex = findKeywordIndex(tokens, { 'past': true, 'after': true });
    if (pastIndex !== -1) {
      var pastMinutes = tokensToMinute(tokens.slice(0, pastIndex));
      var pastHour = tokensToHour(tokens.slice(pastIndex + 1));
      if (pastMinutes !== null && pastHour !== null) {
        return finalizeTime(pastHour, pastMinutes);
      }
    }

    var toIndex = findKeywordIndex(tokens, { 'to': true, 'til': true, 'till': true, 'before': true, 'until': true });
    var numbers = extractNumbers(tokens);

    var hasToKeyword = toIndex !== -1;

    if (!numbers.length) {
      var digitMatch = text.match(/(\d{1,2})\s+(\d{1,2})/);
      if (digitMatch) {
        return finalizeTime(parseInt(digitMatch[1], 10), parseInt(digitMatch[2], 10));
      }
      return null;
    }

    if (numbers.length === 1) {
      var splitGuess = interpretSplitTokens(tokens);
      if (splitGuess) { return splitGuess; }
      return null;
    }

    if (hasToKeyword) {
      var toMinutes = null;
      var toHour = null;
      if (toIndex !== -1) {
        toMinutes = tokensToMinute(tokens.slice(0, toIndex));
        toHour = tokensToHour(tokens.slice(toIndex + 1));
      }
      if (toMinutes === null && numbers.length >= 1) {
        toMinutes = computeMinute([numbers[0]]);
      }
      if (toHour === null && numbers.length >= 2) {
        toHour = numbers[1];
      }
      if (toMinutes !== null && toHour !== null && toHour >= 1 && toHour <= 12) {
        var baseHour = toHour - 1;
        if (baseHour <= 0) { baseHour += 12; }
        return finalizeTime(baseHour, 60 - toMinutes);
      }
    }

    return interpretNumbers(numbers);
  }

  function findKeywordIndex(tokens, keywords) {
    if (!tokens || !tokens.length || !keywords) { return -1; }
    var i;
    for (i = 0; i < tokens.length; i++) {
      if (keywords[tokens[i]]) { return i; }
    }
    return -1;
  }

  function tokensToMinute(segment) {
    if (!segment || !segment.length) { return null; }
    var values = extractNumbers(segment);
    if (!values.length) { return null; }
    var minute = null;
    if (values.length === 1) {
      minute = values[0];
    } else {
      minute = computeMinute(values);
      if (minute === null) {
        minute = values[0];
      }
    }
    if (typeof minute !== 'number') { return null; }
    if (minute < 0) { minute = 0; }
    if (minute > 59) { minute = minute % 60; }
    return minute;
  }

  function tokensToHour(segment) {
    if (!segment || !segment.length) { return null; }
    var values = extractNumbers(segment);
    if (!values.length) { return null; }
    var i;
    for (i = 0; i < values.length; i++) {
      if (values[i] >= 1 && values[i] <= 12) {
        return values[i];
      }
    }
    var fallback = values[0];
    if (fallback <= 0 || !isFinite(fallback)) { fallback = 12; }
    return ((fallback - 1) % 12 + 12) % 12 + 1;
  }

  function interpretSplitTokens(tokens) {
    if (!tokens || tokens.length < 2) { return null; }
    var i;
    for (i = 1; i < tokens.length; i++) {
      var left = tokens.slice(0, i);
      var right = tokens.slice(i);
      var hourCandidate = tokensToHour(left);
      var minuteCandidate = tokensToMinute(right);
      if (hourCandidate !== null && minuteCandidate !== null) {
        return finalizeTime(hourCandidate, minuteCandidate);
      }
    }
    return null;
  }

  function extractNumbers(tokens) {
    var numbers = [];
    var current = null;
    var i;
    var t;
    var filler = {
      'minutes': true, 'minute': true, 'hour': true, 'hours': true,
      'past': true, 'after': true, 'before': true, 'to': true,
      'and': true, 'exactly': true, 'around': true, 'almost': true,
      'about': true, 'its': true, 'it': true, 's': true, 'that': true,
      'thats': true, 'now': true, 'time': true, 'is': true, 'in': true,
      'the': true, 'morning': true, 'evening': true, 'afternoon': true,
      'night': true, 'til': true, 'till': true, 'until': true
    };
    for (i = 0; i < tokens.length; i++) {
      t = tokens[i];
      if (!t) { continue; }
      if (/^\d{1,2}$/.test(t)) {
        if (current !== null) { numbers.push(current); current = null; }
        numbers.push(parseInt(t, 10));
        continue;
      }
      if (filler[t]) {
        if (current !== null) { numbers.push(current); current = null; }
        continue;
      }
      if (t === 'noon') {
        if (current !== null) { numbers.push(current); current = null; }
        numbers.push(12);
        continue;
      }
      if (t === 'midnight') {
        if (current !== null) { numbers.push(current); current = null; }
        numbers.push(12);
        numbers.push(0);
        continue;
      }
      if (t === 'oh' || t === 'o' || t === 'zero') {
        if (current !== null) { numbers.push(current); current = null; }
        numbers.push(0);
        continue;
      }
      var tensValue = getTensValue(t);
      if (tensValue !== null) {
        if (current !== null && current >= 10) {
          numbers.push(current);
          current = null;
        }
        if (current === null) { current = 0; }
        current += tensValue;
        continue;
      }
      var numberValue = getNumberValue(t);
      if (numberValue !== null) {
        if (current !== null && numbers.length === 0 && current >= 10 && numberValue >= 10) {
          numbers.push(current);
          current = null;
        }
        if (current === null) { current = 0; }
        current += numberValue;
        continue;
      }
      if (current !== null) {
        numbers.push(current);
        current = null;
      }
    }
    if (current !== null) {
      numbers.push(current);
    }
    return numbers;
  }

  function getNumberValue(word) {
    var map = {
      'zero': 0, 'one': 1, 'two': 2, 'three': 3, 'four': 4,
      'five': 5, 'six': 6, 'seven': 7, 'eight': 8, 'nine': 9,
      'ten': 10, 'eleven': 11, 'twelve': 12, 'thirteen': 13,
      'fourteen': 14, 'fifteen': 15, 'sixteen': 16, 'seventeen': 17,
      'eighteen': 18, 'nineteen': 19, 'twenty': 20, 'thirty': 30,
      'forty': 40, 'fifty': 50, 'quarter': 15, 'half': 30
    };
    return map.hasOwnProperty(word) ? map[word] : null;
  }

  function getTensValue(word) {
    var map = {
      'twenty': 20,
      'thirty': 30,
      'forty': 40,
      'fifty': 50
    };
    return map.hasOwnProperty(word) ? map[word] : null;
  }

  function interpretNumbers(numbers) {
    if (!numbers || numbers.length < 2) { return null; }
    var hour = numbers[0];
    var rest = numbers.slice(1);
    var minute = null;

    if (hour > 12 && rest.length) {
      var possibleHour = rest[0];
      var possibleMinute = computeMinute([hour].concat(rest.slice(1)));
      if (possibleHour >= 1 && possibleHour <= 12 && possibleMinute !== null) {
        return finalizeTime(possibleHour, possibleMinute);
      }
    }

    minute = computeMinute(rest);
    if (minute === null && rest.length >= 2) {
      minute = computeMinute(rest.slice(1));
    }
    if (minute === null) {
      return null;
    }
    return finalizeTime(hour, minute);
  }

  function computeMinute(rest) {
    if (!rest || !rest.length) { return null; }
    var first = rest[0];
    if (first < 0) { return null; }
    if (first < 60) {
      var minute = first;
      if (rest.length >= 2) {
        var second = rest[1];
        if (minute === 0 && second < 60) {
          minute = second;
        } else if (minute < 10 && second < 10) {
          var combined = minute * 10 + second;
          if (combined < 60) { minute = combined; }
        } else if (minute % 10 === 0 && second < 10) {
          var combined2 = minute + second;
          if (combined2 < 60) { minute = combined2; }
        }
      }
      return minute;
    }
    if (rest.length >= 2 && rest[1] < 60) {
      return rest[1];
    }
    return null;
  }

  function finalizeTime(hour, minute) {
    if (typeof hour !== 'number' || typeof minute !== 'number') { return null; }
    if (hour <= 0) { hour = 12; }
    hour = ((hour - 1) % 12 + 12) % 12 + 1;
    if (minute < 0) { minute = 0; }
    if (minute > 59) { minute = minute % 60; }
    return { hour: hour, minute: minute };
  }

  function randomTime(gran) {
    var h = 1 + Math.floor(Math.random() * 12);
    var steps = Math.floor(60 / gran);
    var m = gran * Math.floor(Math.random() * steps);
    return { h: h, m: m };
  }

  function updateScore(correct) {
    state.attempts += 1;
    if (correct) {
      state.correct += 1;
      state.streak += 1;
    } else {
      state.streak = 0;
    }
    elSC.textContent = String(state.correct);
    elSA.textContent = String(state.attempts);
    elSS.textContent = String(state.streak);
    elSP.textContent = String(state.points);
  }

  function clearFlash() {
    if (!elWrap) { return; }
    elWrap.classList.remove('flash-good');
    elWrap.classList.remove('flash-bad');
  }

  function triggerFlash(type) {
    if (!elWrap) { return; }
    var cls = type === 'good' ? 'flash-good' : 'flash-bad';
    clearFlash();
    // Force reflow so animation restarts when the same result repeats
    void elWrap.offsetWidth;
    elWrap.classList.add(cls);
    setTimeout(function(){
      elWrap.classList.remove(cls);
    }, 1600);
  }

  function newQuestion() {
    clearFlash();
    clearVoiceStatus();
    if (speechEnabled) {
      ensureVoiceListening();
    }
    var t = randomTime(state.gran);
    state.hour = t.h;
    state.minute = t.m;
    draw();
    elFeedback.textContent = '';
    elHour.selectedIndex = 0;
    elMinute.selectedIndex = 0;
    startTimer();
  }

  function calcPoints(ms) {
    var s = ms / 1000; // seconds
    var p = 100 - Math.floor(s);
    if (p < 10) p = 10; // floor
    return p;
  }

  function checkAnswer() {
    var ah = parseInt(elHour.value, 10);
    var am = parseInt(elMinute.value, 10);
    var ok = (ah === state.hour && am === state.minute);

    if (ok) {
      var now = Date.now();
      var ms = now - state.qStart;
      stopTimer();
      var gained = calcPoints(ms);
      state.points += gained;
      updateScore(true);
      triggerFlash('good');
      elFeedback.innerHTML = '<span class="ok">Correct. +' + gained + ' pts</span>';
      // queue next question after small delay so they see the score
      setTimeout(function(){ newQuestion(); }, 2000);
    } else {
      state.points -= WRONG_PENALTY;
      if (state.points < 0) state.points = 0;
      updateScore(false);
      triggerFlash('bad');
      elFeedback.innerHTML = '<span class="bad">Not correct. ‚àí' + WRONG_PENALTY + ' pts</span>';
    }
  }

  function showAnswer() {
    elFeedback.innerHTML = 'Answer: <strong>' + state.hour + ':' + pad2(state.minute) + '</strong>';
  }

  // Timer
  function startTimer() {
    stopTimer();
    state.qStart = Date.now();
    elTimer.textContent = '00:00.0';
    state.timerId = setInterval(function(){
      var ms = Date.now() - state.qStart;
      elTimer.textContent = fmtTime(ms);
    }, 100);
  }

  function stopTimer() {
    if (state.timerId) { clearInterval(state.timerId); state.timerId = null; }
  }

  function fmtTime(ms) {
    var total = Math.floor(ms / 100);
    var tenth = total % 10; // tenths
    var sec = Math.floor(total / 10) % 60;
    var min = Math.floor(total / 600);
    var s = (sec < 10 ? '0' : '') + sec;
    var m = (min < 10 ? '0' : '') + min;
    return m + ':' + s + '.' + tenth;
  }

  // Fullscreen
  function toggleFS() {
    var doc = document;
    if (!doc.fullscreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
      var el = elWrap || panel || doc.documentElement;
      if (el.requestFullscreen) el.requestFullscreen();
      else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
      else if (el.msRequestFullscreen) el.msRequestFullscreen();
    } else {
      if (doc.exitFullscreen) doc.exitFullscreen();
      else if (doc.webkitExitFullscreen) doc.webkitExitFullscreen();
      else if (doc.msExitFullscreen) doc.msExitFullscreen();
    }
  }

  function onFSChange() {
    var doc = document;
    var active = !!(doc.fullscreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement);
    btnFS.textContent = active ? 'Exit Full Screen' : 'Full Screen';
    setTimeout(function(){ draw(); }, 100);
  }

  // Drawing
  function draw() {
    scaleForDPR();
    var rect = canvas.getBoundingClientRect();
    var W = rect.width;
    var H = rect.width;
    var r = Math.min(W, H) * 0.48;

    ctx.clearRect(0, 0, W, H);

    ctx.save();
    ctx.translate(W/2, H/2);

    // Outer circle
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2, false);
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#222';
    ctx.stroke();

    // Minute tick marks only for 1-min mode
    if (state.gran === 1) {
      var i;
      for (i = 0; i < 60; i++) {
        var ang = (Math.PI/30) * i; // 6¬∞
        var is5 = (i % 5 === 0);
        var inner = r * (is5 ? 0.86 : 0.92);
        var outer = r * 0.98;
        ctx.beginPath();
        ctx.moveTo(inner * Math.cos(ang), inner * Math.sin(ang));
        ctx.lineTo(outer * Math.cos(ang), outer * Math.sin(ang));
        ctx.lineWidth = is5 ? 2 : 1;
        ctx.strokeStyle = '#c7c7c7';
        ctx.stroke();
      }
    }

    // Hour numbers 1..12 only
    ctx.fillStyle = '#111';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.font = Math.round(r * 0.14) + 'px Arial';
    var n;
    for (n = 1; n <= 12; n++) {
      var angN = (Math.PI / 6) * (n - 3);
      var nr = r * 0.78;
      var x = nr * Math.cos(angN);
      var y = nr * Math.sin(angN);
      ctx.fillText(String(n), x, y);
    }

    // Axle cap under hands shadow
    ctx.beginPath();
    ctx.arc(0, 0, Math.max(3, r*0.03), 0, Math.PI*2, false);
    ctx.fillStyle = '#444';
    ctx.fill();

    // Compute hand angles accurately
    var m = state.minute;
    var h = state.hour % 12;
    var minuteDeg = m * 6;          // 6¬∞ per minute
    var hourDeg = h * 30 + m * 0.5; // 30¬∞ per hour + 0.5¬∞ per minute

    // Draw hour hand
    drawHand((hourDeg - 90) * Math.PI/180, r * 0.55, Math.max(6, Math.round(r*0.06)), '#111');

    // Draw minute hand
    drawHand((minuteDeg - 90) * Math.PI/180, r * 0.85, Math.max(4, Math.round(r*0.04)), '#0f62fe');

    // Center cap on top
    ctx.beginPath();
    ctx.arc(0, 0, Math.max(3, r*0.035), 0, Math.PI*2, false);
    ctx.fillStyle = '#000';
    ctx.fill();

    ctx.restore();
  }

  function drawHand(angleRad, length, width, color) {
    ctx.save();
    ctx.rotate(angleRad);
    ctx.beginPath();
    ctx.moveTo(-width*0.25, 0);
    ctx.lineTo(length, 0);
    ctx.lineWidth = width;
    ctx.lineCap = 'round';
    ctx.strokeStyle = color;
    ctx.stroke();
    ctx.restore();
  }

  // Init UI
  setHourOptions();
  setMinuteOptions(state.gran);
  elGran.value = String(state.gran);

  if (SpeechRecognition && elVoiceBtn && elVoiceRow) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 5;

    recognition.addEventListener('result', function(event){
      handleVoiceResult(event);
    });

    recognition.addEventListener('error', function(event){
      var message = 'Listening error. Please try again.';
      if (event && event.error === 'no-speech') {
        message = 'No speech detected. Try speaking again.';
      } else if (event && event.error === 'audio-capture') {
        message = 'Microphone not available. Check your device.';
      } else if (event && (event.error === 'not-allowed' || event.error === 'service-not-allowed')) {
        message = 'Microphone access was blocked.';
      }

      listening = false;

      if (event && (event.error === 'audio-capture' || event.error === 'not-allowed' || event.error === 'service-not-allowed')) {
        disableVoice(message);
      } else {
        updateVoiceUI();
        setVoiceStatus(message);
        if (speechEnabled) {
          setTimeout(function(){ ensureVoiceListening(); }, 1200);
        }
      }
    });

    recognition.addEventListener('end', function(){
      listening = false;
      updateVoiceUI();
      if (speechEnabled) {
        setTimeout(function(){ ensureVoiceListening(); }, 250);
      }
    });

    elVoiceBtn.addEventListener('click', function(){
      if (speechEnabled) {
        disableVoice();
      } else {
        enableVoice();
        clearVoiceStatus();
      }
    });

    enableVoice();
  } else if (elVoiceRow && elVoiceBtn) {
    elVoiceBtn.disabled = true;
    elVoiceBtn.title = 'Voice recognition is not supported in this browser.';
    setVoiceStatus('Voice recognition is not available in this browser.');
  }

  // Events
  elGran.addEventListener('change', function(){
    var g = parseInt(elGran.value, 10);
    state.gran = g;
    setMinuteOptions(g);
    newQuestion();
  });

  elNew.addEventListener('click', function(){ newQuestion(); });
  elCheck.addEventListener('click', function(){ checkAnswer(); });
  elShow.addEventListener('click', function(){ showAnswer(); });
  elRestart.addEventListener('click', function(){ restartAll(); });

  btnFS.addEventListener('click', toggleFS);
  document.addEventListener('fullscreenchange', onFSChange);
  document.addEventListener('webkitfullscreenchange', onFSChange);
  document.addEventListener('MSFullscreenChange', onFSChange);

  // Keyboard Enter to check
  elMinute.addEventListener('keyup', function(ev){ if ((ev.keyCode||ev.which) === 13) { checkAnswer(); } });
  elHour.addEventListener('keyup', function(ev){ if ((ev.keyCode||ev.which) === 13) { checkAnswer(); } });

  // Restart
  function restartAll() {
    stopTimer();
    clearVoiceStatus();
    if (speechEnabled) {
      ensureVoiceListening();
    }
    state.correct = 0;
    state.attempts = 0;
    state.streak = 0;
    state.points = 0;
    elSC.textContent = '0';
    elSA.textContent = '0';
    elSS.textContent = '0';
    elSP.textContent = '0';
    elFeedback.textContent = '';
    newQuestion();
  }

  // First question
  newQuestion();

  // Redraw on resize for crispness
  window.addEventListener('resize', function(){ draw(); });
})();
</script>
</body>
</html>
